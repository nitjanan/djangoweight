{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load humanize %}
{% load templatehelpers %}

{% block css %}
<link
rel="stylesheet"
href="{% static 'extensions/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}"
/>
<link rel="stylesheet" href="{% static 'compiled/css/table-datatable-jquery.css' %}"/>
<style>
    @media print {
        body {
            visibility: hidden;
            font-size:10px;
            font-family:"Times New Roman";
        }
        .section{
            visibility: visible;
            position: absolute;
            left: 0;
            top: 0;
        }
        @page { size: landscape; }
	}

    .doubleUnderline {
        text-decoration-line: underline;
        text-decoration-style: double;
    }
    
  </style>
{% endblock %}

{% block content %}
<header class="mb-3">
    <a href="#" class="burger-btn d-block d-xl-none">
      <i class="bi bi-justify fs-3"></i>
    </a>
  </header>

  <div class="page-heading">
    <div class="page-title">
      <div class="row">
        <div class="col-12 col-md-6 order-md-1 order-last">
          <h3>Weekly Report</h3>
        </div>
        <div class="col-12 col-md-6 order-md-2 order-first">
          <nav
            aria-label="breadcrumb"
            class="breadcrumb-header float-start float-lg-end"
          >
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="{% url 'home' %}">Dashboard</a>
              </li>
              <li class="breadcrumb-item">
                <a href="{% url 'viewProduction' %}">Production</a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">
                Weekly Report
              </li>
            </ol>
          </nav>
        </div>
      </div>
    </div>

    <!-- Basic Tables start -->
    <section class="section">
      <div class="card">
        <div class="card-body">
            <div class="row">
                <button type="button" class="col-2 btn btn-secondary pull-right d-print-none" onclick="window.print();">
                    <i class="fas fa-print"></i>
                    ปริ้น Weekly Report
                </button>
            </div>
            <div class="table-responsive">
            <div class="row">
                {% for i in pd %}
                <div class="col">
                    <div class="table-responsive my-3 col">
                        <table id="myTable" class="table table-hover">
                          <thead class="table-dark">
                            <tr class="{% if forloop.counter0  == 0 %}table-success{% elif forloop.counter0  == 1%}table-primary{% elif forloop.counter0  == 2%}table-warning{%endif%}">
                              <th colspan="3">{{i.site__base_site_name}}</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td>กำหนดยอดป้อน วันที่ 1-{{date_object|date:"j F Y" }}</td>
                              <td>{{i.pd_goal__accumulated_goal|intcomma }}</td>
                              <td>ตัน</td>
                            </tr>
                            <tr>
                                <td>ทำการผลิตหินจริง</td>
                                <td>{{i.sum_goal|intcomma}}</td>
                                <td>ตัน</td>
                            </tr>
                            <tr>
                                <td>คิดเป็น</td>
                                <td>{{i.persent}}%</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>ยอดที่หายไป</td>
                                <td>{{i.loss_weight|intcomma}}</td>
                                <td>ตัน</td>
                            </tr>
                            <tr>
                                <td>กำลังการผลิต (Performance)</td>
                                <td>170.86</td>
                                <td>ตัน</td>
                            </tr>
                            <tr>
                                <td class="{% if forloop.counter0  == 0 %}table-success{% elif forloop.counter0  == 1%}table-primary{% elif forloop.counter0  == 2%}table-warning{%endif%}" colspan="3">สาเหตุการหยุดทำงานของเครื่องจักร จากตัวเครื่องโม่</td>
                            </tr>
                            <tr>
                                <td>- หยุดซ่อมบำรุง JAW CRUSHER</td>
                                <td>{% for pl in pd_loss %}{% if i.site__base_site_id == pl.production__site__base_site_id and pl.mc_type == 2 %}{{pl.sum_time| format_duration_substring}}{% endif %}{% endfor %}</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>- หยุดซ่อมบำรุง CONE CRUSHER</td>
                                <td>{% for pl in pd_loss %}{% if i.site__base_site_id == pl.production__site__base_site_id and pl.mc_type == 3 %}{{pl.sum_time| format_duration_substring}}{% endif %}{% endfor %}</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>- หยุดซ่อมบำรุง VIBRATING SCREEN / WARRIOR</td>
                                <td class="text-decoration-underline">{% for pl in pd_loss %}{% if i.site__base_site_id == pl.production__site__base_site_id and pl.mc_type == 5 %}{{pl.sum_time| format_duration_substring}}{% endif %}{% endfor %}</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>- รวมเวลาสูญเสียจากการหยุดซ่อมบำรุงเครื่องจักรทั้งหมด</td>
                                <td class="text-danger doubleUnderline">19:37</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>ความพร้อมของเครื่องจักรสูงสุดในการใช้งาน</td>
                                <td>255:21</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>ความพร้อมของเครื่องจักรในการใช้งานจริง</td>
                                <td>255:21</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>เครื่องจักรหยุดทำงานอันเป็นสาเหตุ <p class="text-primary">จากตัวเครื่องโม่</p></td>
                                <td class="text-danger doubleUnderline">5%</td>
                                <td></td>
                            </tr>

                            <tr>
                                <td class="{% if forloop.counter0  == 0 %}table-success{% elif forloop.counter0  == 1%}table-primary{% elif forloop.counter0  == 2%}table-warning{%endif%}" colspan="3">สาเหตุการหยุดทำงานของเครื่องจักร จากเหมืองศิลาชัย</td>
                            </tr>
                            <tr>
                                <td>- รอหินป้อนเข้าโรงโม่</td>
                                <td>6:44</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>- หินใหญ่เกินขนาดติดปากจอว์</td>
                                <td>3:27</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>- เคาะแผ่นตระแกรง (แก้ไขคุณภาพหิน)</td>
                                <td class="text-decoration-underline">8:37</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>- รวมเวลาสูญสียจากเหมืองเจโอบีทั้งหมด</td>
                                <td class="text-danger doubleUnderline">19:37</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>ความพร้อมของเครื่องจักรสูงสุดในการใช้งาน</td>
                                <td>255:21</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>ความพร้อมของเครื่องจักรในการใช้งานจริง</td>
                                <td>255:21</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>เครื่องจักรหยุดทำงานอันเป็นสาเหตุ <p class="text-primary">จากวัตถุดิบและคนทำงาน</p></td>
                                <td class="text-danger doubleUnderline">5%</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td class="{% if forloop.counter0  == 0 %}table-success{% elif forloop.counter0  == 1%}table-primary{% elif forloop.counter0  == 2%}table-warning{%endif%}" colspan="3">สรุปประสิทธิภาพในการทำงานโดยรวมเครื่องจักร</td>
                            </tr>
                            <tr>
                                <td>ความพร้อมของเครื่องจักรสูงสุดในการใช้งาน</td>
                                <td>255:21</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>ความพร้อมของเครื่องจักรในการใช้งานจริง</td>
                                <td>255:21</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>เครื่องจักรหยุดทำงานอันเป็นสาเหตุ <p class="text-primary">จากตัวเครื่องโม่</p></td>
                                <td class="text-danger">19:00</td>
                                <td>ชม./เดือน</td>
                            </tr>
                            <tr>
                                <td>เครื่องจักรหยุดทำงานอันเป็นสาเหตุ <p class="text-primary">จากวัตถุดิบและคนทำงาน</p></td>
                                <td class="text-danger">12:05</td>
                                <td>ชม./เดือน</td>
                            </tr>
                          </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="row">
                <div class="col">
                    <div class="table-responsive my-3 col">
                        <table class="table table-hover">
                          <tbody>
                            <tr>
                                <td> - JAW CRUSHER</td>
                                <td>6:44</td>
                            </tr>
                            <tr>
                                <td> - CONE CRUSHER</td>
                                <td>3:27</td>
                            </tr>
                            <tr>
                                <td> - SCREEN</td>
                                <td>8:49</td>
                            </tr>
                            <tr>
                                <td> - รอหินป้อน</td>
                                <td>6:19</td>
                            </tr>
                            <tr>
                                <td> - หินใหญ่เกินขนาด</td>
                                <td>0:44</td>
                            </tr>
                            <tr>
                                <td> - เคาะแผ่นตะแกรง</td>
                                <td>5:03</td>
                            </tr>
                            <tr class="table-success">
                                <td>รวมเวลาสูญเสียทั้งหมด</td>
                                <td>31:05</td>
                            </tr>
                          </tbody>
                        </table>
                    </div>
                </div>
                <div class="col">
                    <div class="table-responsive my-3 col">
                        <table class="table table-hover">
                          <tbody>
                            <tr>
                                <td> - JAW CRUSHER</td>
                                <td>6:44</td>
                            </tr>
                            <tr>
                                <td> - CONE CRUSHER</td>
                                <td>3:27</td>
                            </tr>
                            <tr>
                                <td> - SCREEN</td>
                                <td>8:49</td>
                            </tr>
                            <tr>
                                <td> - รอหินป้อน</td>
                                <td>6:19</td>
                            </tr>
                            <tr>
                                <td> - หินใหญ่เกินขนาด</td>
                                <td>0:44</td>
                            </tr>
                            <tr>
                                <td> - เคาะแผ่นตะแกรง</td>
                                <td>5:03</td>
                            </tr>
                            <tr class="table-primary">
                                <td>รวมเวลาสูญเสียทั้งหมด</td>
                                <td>31:05</td>
                            </tr>
                          </tbody>
                        </table>
                    </div>
                </div>
                <div class="col">
                    <div class="table-responsive my-3 col">
                        <table class="table table-hover">
                          <tbody>
                            <tr>
                                <td> - JAW CRUSHER</td>
                                <td>6:44</td>
                            </tr>
                            <tr>
                                <td> - CONE CRUSHER</td>
                                <td>3:27</td>
                            </tr>
                            <tr>
                                <td> - SCREEN</td>
                                <td>8:49</td>
                            </tr>
                            <tr>
                                <td> - รอหินป้อน</td>
                                <td>6:19</td>
                            </tr>
                            <tr>
                                <td> - หินใหญ่เกินขนาด</td>
                                <td>0:44</td>
                            </tr>
                            <tr>
                                <td> - เคาะแผ่นตะแกรง</td>
                                <td>5:03</td>
                            </tr>
                            <tr class="table-warning">
                                <td>รวมเวลาสูญเสียทั้งหมด</td>
                                <td>31:05</td>
                            </tr>
                          </tbody>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="card-body">
                            <div id="chart_site_1"></div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card-body">
                            <div id="chart_site_2"></div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card-body">
                            <div id="chart_site_3"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
      </div>
    </section>
    <!-- Basic Tables end -->
  </div>
  <footer>
    <div class="footer clearfix mb-0 text-muted">
      <div class="float-start">
        <p>2023 &copy; Nitjanan</p>
      </div>
      <div class="float-end">
        <!-- p>
          Crafted with
          <span class="text-danger"
            ><i class="bi bi-heart-fill icon-mid"></i
          ></span>
          by <a href="https://saugi.me">Saugi</a>
        </p -->
      </div>
    </div>
  </footer>
{% endblock %}

{% block script %}
<script src="{% static 'js/components/dark.js' %}"></script>
<script src="{% static 'extensions/perfect-scrollbar/perfect-scrollbar.min.js' %}"></script>

<script src="{% static 'compiled/js/app.js' %}"></script>

<script src="{% static 'extensions/jquery/jquery.min.js' %}"></script>
<script src="https://cdn.datatables.net/v/bs5/dt-1.12.1/datatables.min.js"></script>
<script src="{% static 'js/pages/datatables.js' %}"></script>
<!-- Need: Apexcharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    function exportToExcel() {
        var table = document.getElementById("myTable");
        var rows = table.querySelectorAll("tbody tr");
        var csvContent = "\uFEFF"; // BOM (Byte Order Mark) to ensure correct encoding

        rows.forEach(function (row) {
            var columns = row.querySelectorAll("td");
            var rowData = [];
            columns.forEach(function (column) {
                rowData.push('"' + column.textContent.trim() + '"');
            });
            csvContent += rowData.join(",") + "\n";
        });

        var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        var link = document.createElement("a");
        link.href = window.URL.createObjectURL(blob);
        link.download = "table.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // site 1
       var optionsSite1 = {
        series: {{list_ls1_val|safe}},
        chart: {
          width: '100%',
          type: 'pie',
        },
        /*
        colors:[
        'rgba(255, 99, 132, 0.8)',
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 206, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)',
        'rgba(255, 51, 227, 0.8)',
        'rgba(39, 16, 205, 0.8)',
        'rgba(205, 45, 16, 0.8)',
        ],
        */
        labels: {{list_ls1_name|safe}},
        plotOptions: {
          pie: {
            dataLabels: {
              offset: -5
            }
          }
        },
        title: {
          text: "สาเหตุการหยุดทำงาน โรงโม่ 1",
          style: {
            fontSize:  '16px',
            fontWeight:  'bold',
            fontFamily:  undefined,
            color:  '#5D6D7E',
            },
        },
        dataLabels: {
          formatter(val, opts) {
            const name = opts.w.globals.labels[opts.seriesIndex]
            return [name, val + '%']
          }
        },
        legend: {
          show: false
        }
        };

        // site 2
        var optionsSite2 = {
        series: {{list_ls2_val|safe}},
        chart: {
          width: '100%',
          type: 'pie',
        },
        /*
        colors:[
        'rgba(255, 99, 132, 0.8)',
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 206, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)',
        'rgba(255, 51, 227, 0.8)',
        'rgba(39, 16, 205, 0.8)',
        'rgba(205, 45, 16, 0.8)',
        ],
        */
        labels: {{list_ls2_name|safe}},
        plotOptions: {
          pie: {
            dataLabels: {
              offset: -5
            }
          }
        },
        title: {
          text: "สาเหตุการหยุดทำงาน โรงโม่ 2",
          style: {
            fontSize:  '16px',
            fontWeight:  'bold',
            fontFamily:  undefined,
            color:  '#5D6D7E',
            },
        },
        dataLabels: {
          formatter(val, opts) {
            const name = opts.w.globals.labels[opts.seriesIndex]
            return [name, val + '%']
          }
        },
        legend: {
          show: false
        }
        };
        
        // site 3
        var optionsSite3 = {
        series: {{list_ls3_val|safe}},
        chart: {
          width: '100%',
          type: 'pie',
        },
        /*
        colors:[
        'rgba(255, 99, 132, 0.8)',
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 206, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)',
        'rgba(255, 51, 227, 0.8)',
        'rgba(39, 16, 205, 0.8)',
        'rgba(205, 45, 16, 0.8)',
        ],
        */
        labels: {{list_ls3_name|safe}},
        plotOptions: {
          pie: {
            dataLabels: {
              offset: -5
            }
          }
        },
        title: {
          text: "สาเหตุการหยุดทำงาน โรงโม่ 3",
          style: {
            fontSize:  '16px',
            fontWeight:  'bold',
            fontFamily:  undefined,
            color:  '#5D6D7E',
            },
        },
        dataLabels: {
          formatter(val, opts) {
            const name = opts.w.globals.labels[opts.seriesIndex]
            return [name, val + '%']
          }
        },
        legend: {
          show: false
        }
        };

        var chart = new ApexCharts(document.querySelector("#chart_site_1"), optionsSite1);
        chart.render();

        var chart = new ApexCharts(document.querySelector("#chart_site_2"), optionsSite2);
        chart.render();

        var chart = new ApexCharts(document.querySelector("#chart_site_3"), optionsSite3);
        chart.render();
</script>
{% endblock %}